# æ¤é—´ç›˜ 3D è‡ªåŠ¨åˆ†å‰²æ¨¡å—

åŸºäº **SAM-Med3D** çš„æ¤é—´ç›˜ MRI å›¾åƒ 3D åˆ†å‰²å·¥å…·ï¼Œç”¨äºä»å¤´é¢ˆéƒ¨ MRI ä¸­è‡ªåŠ¨è¯†åˆ«å’Œåˆ†å‰²æ¤é—´ç›˜åŒºåŸŸã€‚

## ğŸ“‹ ç›®å½•

- [é¡¹ç›®ç®€ä»‹](#é¡¹ç›®ç®€ä»‹)
- [ä¸¤ç§åˆ†å‰²æ–¹æ¡ˆ](#ä¸¤ç§åˆ†å‰²æ–¹æ¡ˆ)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [è¯¦ç»†ä½¿ç”¨è¯´æ˜](#è¯¦ç»†ä½¿ç”¨è¯´æ˜)
- [è¾“å‡ºç»“æœè¯´æ˜](#è¾“å‡ºç»“æœè¯´æ˜)
- [ä»£ç ç»“æ„](#ä»£ç ç»“æ„)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## é¡¹ç›®ç®€ä»‹

æœ¬æ¨¡å—å°†åŒ»é™¢å¯¼å‡ºçš„ **DICOM æ ¼å¼ MRI æ•°æ®** è½¬æ¢ä¸ºå¯åˆ†æçš„ **NIfTI æ ¼å¼**ï¼Œå¹¶ä½¿ç”¨æ·±åº¦å­¦ä¹ æ¨¡å‹ SAM-Med3D è¿›è¡Œæ¤é—´ç›˜çš„ 3D åˆ†å‰²ã€‚åˆ†å‰²ç»“æœå¯ç›´æ¥ç”¨äº `ivd_degeneration_analysis` é¡¹ç›®çš„ç‰¹å¾æå–å’Œåˆ†æã€‚

### å½“å‰æ•°æ®

| ç—…ä¾‹ | æ–‡ä»¶ | å¤§å° | ä½ç½® |
|------|------|------|------|
| liang | liang.zip | 51 MB | `/home/nyuair/junyi/SAM-Med3D/9hospital/` |
| wu | wu.zip | 41 MB | `/home/nyuair/junyi/SAM-Med3D/9hospital/` |
| zhang | zhang.zip | 17 MB | `/home/nyuair/junyi/SAM-Med3D/9hospital/` |

---

## ä¸¤ç§åˆ†å‰²æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¸âƒ£: äº¤äº’å¼åˆ†å‰²ï¼ˆæ¨èç°é˜¶æ®µä½¿ç”¨ï¼‰

**é€‚ç”¨åœºæ™¯**: ç—…ä¾‹æ•°é‡è¾ƒå°‘ï¼ˆ<20ä¾‹ï¼‰ï¼Œè¿½æ±‚é«˜ç²¾åº¦

**å·¥ä½œåŸç†**:
1. åœ¨ 3D è§†å›¾ä¸­æµè§ˆ MRI å›¾åƒ
2. ç”¨é¼ æ ‡ç‚¹å‡»æ¤é—´ç›˜åŒºåŸŸä½œä¸º"æç¤ºç‚¹"
3. SAM-Med3D æ¨¡å‹æ ¹æ®æç¤ºç‚¹è‡ªåŠ¨ç”Ÿæˆåˆ†å‰²æ©ç 
4. å¯æ‰‹åŠ¨ä¿®æ­£åä¿å­˜

**ä¼˜ç‚¹**:
- æ— éœ€é¢„å…ˆæ ‡æ³¨è®­ç»ƒæ•°æ®
- åˆ†å‰²ç²¾åº¦é«˜ï¼Œå¯å®æ—¶è°ƒæ•´
- æ¯ä¾‹çº¦ 3-5 åˆ†é’Ÿ

**æµç¨‹å›¾**:
```
DICOM ZIP â†’ NIfTI è½¬æ¢ â†’ äº¤äº’å¼ GUI â†’ ç‚¹å‡»æç¤º â†’ è‡ªåŠ¨åˆ†å‰² â†’ ä¿å­˜æ©ç 
```

---

### æ–¹æ¡ˆ2ï¸âƒ£: å¾®è°ƒåˆ†å‰²ï¼ˆé€‚åˆå¤§é‡ç—…ä¾‹ï¼‰

**é€‚ç”¨åœºæ™¯**: ç—…ä¾‹æ•°é‡å¤šï¼ˆ>20ä¾‹ï¼‰ï¼Œè¿½æ±‚è‡ªåŠ¨åŒ–

**å·¥ä½œåŸç†**:
1. å…ˆç”¨æ–¹æ¡ˆ1æ ‡æ³¨ 10-20 ä¾‹ä½œä¸ºè®­ç»ƒæ•°æ®
2. å¾®è°ƒ SAM-Med3D æ¨¡å‹
3. ä½¿ç”¨å¾®è°ƒåçš„æ¨¡å‹è‡ªåŠ¨åˆ†å‰²æ–°ç—…ä¾‹

**ä¼˜ç‚¹**:
- å®Œå…¨è‡ªåŠ¨åŒ–ï¼Œæ— éœ€äººå·¥å¹²é¢„
- é€‚åˆæ‰¹é‡å¤„ç†
- æ¯ä¾‹ä»…éœ€å‡ ç§’é’Ÿ

**æµç¨‹å›¾**:
```
æ ‡æ³¨æ•°æ® â†’ æ•°æ®é¢„å¤„ç† â†’ æ¨¡å‹å¾®è°ƒ â†’ è‡ªåŠ¨åˆ†å‰² â†’ æ‰¹é‡è¾“å‡º
```

---

## å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# æ¿€æ´»ç¯å¢ƒ
conda activate sammed3d  # æˆ–ä½ çš„ç¯å¢ƒå

# å®‰è£…ä¾èµ–
pip install nibabel SimpleITK numpy matplotlib torch torchio monai medim
```

### 2. ä¸‹è½½æ¨¡å‹æƒé‡ï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰

```bash
# åˆ›å»ºç›®å½•
mkdir -p /home/nyuair/junyi/SAM-Med3D/ckpt

# ä¸‹è½½ SAM-Med3D-turbo æƒé‡ (çº¦ 1.2 GB)
wget https://huggingface.co/blueyo0/SAM-Med3D/resolve/main/sam_med3d_turbo.pth \
    -O /home/nyuair/junyi/SAM-Med3D/ckpt/sam_med3d_turbo.pth
```

### 3. å¿«é€Ÿå¯åŠ¨

```bash
cd /home/nyuair/junyi/ivd_degeneration_analysis/segmentation

# æŸ¥çœ‹å½“å‰æ•°æ®çŠ¶æ€
python quick_start.py status

# è½¬æ¢æ‰€æœ‰ DICOM åˆ° NIfTI
python quick_start.py convert

# äº¤äº’å¼åˆ†å‰² liang ç—…ä¾‹
python quick_start.py segment liang
```

---

## è¯¦ç»†ä½¿ç”¨è¯´æ˜

### æ–¹æ¡ˆ1: äº¤äº’å¼åˆ†å‰²

#### æ­¥éª¤1: è½¬æ¢ DICOM åˆ° NIfTI

```bash
# è½¬æ¢å•ä¸ªç—…ä¾‹
python dicom_to_nifti.py \
    /home/nyuair/junyi/SAM-Med3D/9hospital/liang.zip \
    ./output/nifti/liang.nii.gz

# æˆ–ä½¿ç”¨å¿«é€Ÿå‘½ä»¤
python quick_start.py convert liang
```

#### æ­¥éª¤2: å¯åŠ¨äº¤äº’å¼åˆ†å‰²

```bash
python interactive_segment.py ./output/nifti/liang.nii.gz --output-dir ./output/masks
```

#### äº¤äº’å¼ç•Œé¢æ“ä½œè¯´æ˜

| æ“ä½œ | è¯´æ˜ |
|------|------|
| **å·¦é”®ç‚¹å‡»** | æ·»åŠ å‰æ™¯ç‚¹ï¼ˆç»¿è‰²åœ†ç‚¹ï¼‰ï¼Œæ ‡è®°æ¤é—´ç›˜å†…éƒ¨ |
| **å³é”®ç‚¹å‡»** | æ·»åŠ èƒŒæ™¯ç‚¹ï¼ˆçº¢è‰²å‰å·ï¼‰ï¼Œæ ‡è®°éæ¤é—´ç›˜åŒºåŸŸ |
| **æ»‘å—** | è°ƒæ•´åˆ‡ç‰‡ä½ç½®ï¼Œæµè§ˆä¸åŒå±‚é¢ |
| **åˆ†å‰²æŒ‰é’®** | æ‰§è¡Œåˆ†å‰²ï¼Œç”Ÿæˆæ©ç  |
| **æ¸…é™¤ç‚¹æŒ‰é’®** | æ¸…é™¤æ‰€æœ‰æç¤ºç‚¹ |
| **ä¿å­˜ç»“æœæŒ‰é’®** | ä¿å­˜å½“å‰æ¤é—´ç›˜çš„åˆ†å‰²æ©ç  |
| **ä¸‹ä¸€ä¸ªæ¤é—´ç›˜æŒ‰é’®** | åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ¤é—´ç›˜ (L1-L2 â†’ L2-L3 â†’ ...) |

#### åˆ†å‰²æŠ€å·§

1. **å…ˆå®šä½**: ç”¨æ»‘å—æ‰¾åˆ°æ¤é—´ç›˜æ‰€åœ¨çš„åˆ‡ç‰‡
2. **å¤šè§†å›¾**: åœ¨çŸ¢çŠ¶ä½ã€å† çŠ¶ä½ã€è½´ä½ä¸‰ä¸ªè§†å›¾ä¸­éƒ½ç‚¹å‡»
3. **å‰æ™¯+èƒŒæ™¯**: åŒæ—¶ä½¿ç”¨å‰æ™¯ç‚¹å’ŒèƒŒæ™¯ç‚¹æ•ˆæœæ›´å¥½
4. **3-5ä¸ªç‚¹**: é€šå¸¸ 3-5 ä¸ªæç¤ºç‚¹å°±å¤Ÿäº†

---

### æ–¹æ¡ˆ2: å¾®è°ƒåˆ†å‰²

#### æ­¥éª¤1: å‡†å¤‡æ ‡æ³¨æ•°æ®

ä½¿ç”¨æ–¹æ¡ˆ1æ ‡æ³¨ 10-20 ä¾‹æ•°æ®ï¼Œä¿å­˜åˆ°æŒ‡å®šç›®å½•ï¼š

```
./labeled_data/
â”œâ”€â”€ liang.nii.gz
â”œâ”€â”€ liang_mask.nii.gz
â”œâ”€â”€ wu.nii.gz
â”œâ”€â”€ wu_mask.nii.gz
â””â”€â”€ ...
```

#### æ­¥éª¤2: è½¬æ¢ä¸ºè®­ç»ƒæ ¼å¼

```bash
python prepare_finetune_data.py ./labeled_data ./finetune_data
```

è¿™ä¼šç”Ÿæˆ SAM-Med3D æ ¼å¼çš„è®­ç»ƒæ•°æ®ï¼š
- æ¯ä¸ªæ¤é—´ç›˜å•ç‹¬æå–ä¸ºä¸€ä¸ªæ ·æœ¬
- è‡ªåŠ¨è£å‰ª ROI åŒºåŸŸ
- è‡ªåŠ¨é‡é‡‡æ ·åˆ° 128Ã—128Ã—128

#### æ­¥éª¤3: è¿è¡Œå¾®è°ƒ

```bash
python finetune_sam_med3d.py \
    --data-dir ./finetune_data/ivd/mri_IVD \
    --checkpoint /home/nyuair/junyi/SAM-Med3D/ckpt/sam_med3d_turbo.pth \
    --output-dir ./output/models \
    --epochs 50 \
    --batch-size 2 \
    --lr 1e-4
```

**å‚æ•°è¯´æ˜**:

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--epochs` | 50 | è®­ç»ƒè½®æ•° |
| `--batch-size` | 2 | æ‰¹æ¬¡å¤§å°ï¼ˆæ˜¾å­˜ä¸è¶³æ—¶å‡å°ï¼‰ |
| `--lr` | 1e-4 | å­¦ä¹ ç‡ |
| `--freeze-encoder` | False | å†»ç»“ç¼–ç å™¨ï¼ˆå¯å‡å°‘æ˜¾å­˜å ç”¨ï¼‰ |
| `--val-split` | 0.2 | éªŒè¯é›†æ¯”ä¾‹ |

#### æ­¥éª¤4: ä½¿ç”¨å¾®è°ƒåçš„æ¨¡å‹

```bash
# äº¤äº’å¼åˆ†å‰²ï¼ˆä½¿ç”¨å¾®è°ƒæ¨¡å‹ï¼‰
python interactive_segment.py case.nii.gz \
    --checkpoint ./output/models/best_model.pth

# æ‰¹é‡è‡ªåŠ¨åˆ†å‰²
python run_segmentation_pipeline.py \
    --input-dir ./new_cases \
    --batch \
    --checkpoint ./output/models/best_model.pth
```

---

## è¾“å‡ºç»“æœè¯´æ˜

### æ–‡ä»¶æ ¼å¼

| ç±»å‹ | æ ¼å¼ | è¯´æ˜ |
|------|------|------|
| åŸå§‹å›¾åƒ | `.nii.gz` | 3D NIfTI æ ¼å¼ MRI å›¾åƒ |
| åˆ†å‰²æ©ç  | `.nii.gz` | 3D NIfTI æ ¼å¼æ ‡ç­¾å›¾åƒ |

### æ©ç æ ‡ç­¾å€¼

ä¸ `ivd_degeneration_analysis` é¡¹ç›®å…¼å®¹çš„æ ‡ç­¾ï¼š

| æ¤é—´ç›˜ | æ ‡ç­¾å€¼ | ä¸Šæ¤ä½“ | ä¸‹æ¤ä½“ |
|--------|--------|--------|--------|
| L1-L2 | 3 | 2 | 4 |
| L2-L3 | 5 | 4 | 6 |
| L3-L4 | 7 | 6 | 8 |
| L4-L5 | 9 | 8 | 10 |
| L5-S1 | 11 | 10 | 12 |

ç¡¬è†œå›Šæ ‡ç­¾: **20**

### è¾“å‡ºç›®å½•ç»“æ„

```
./output/
â”œâ”€â”€ nifti/                      # NIfTI è½¬æ¢ç»“æœ
â”‚   â”œâ”€â”€ liang.nii.gz
â”‚   â”œâ”€â”€ wu.nii.gz
â”‚   â””â”€â”€ zhang.nii.gz
â”œâ”€â”€ masks/                      # åˆ†å‰²æ©ç 
â”‚   â”œâ”€â”€ liang_L4-L5_mask.nii.gz
â”‚   â”œâ”€â”€ liang_L5-S1_mask.nii.gz
â”‚   â””â”€â”€ ...
â””â”€â”€ models/                     # å¾®è°ƒæ¨¡å‹ï¼ˆæ–¹æ¡ˆ2ï¼‰
    â”œâ”€â”€ best_model.pth
    â”œâ”€â”€ final_model.pth
    â””â”€â”€ training_curves.png
```

---

## ä»£ç ç»“æ„

```
segmentation/
â”œâ”€â”€ config.py                   # é…ç½®æ–‡ä»¶ï¼ˆè·¯å¾„ã€å‚æ•°ï¼‰
â”œâ”€â”€ quick_start.py              # å¿«é€Ÿå¯åŠ¨è„šæœ¬
â”œâ”€â”€ dicom_to_nifti.py          # DICOM è½¬ NIfTI å·¥å…·
â”œâ”€â”€ interactive_segment.py      # æ–¹æ¡ˆ1: äº¤äº’å¼åˆ†å‰² GUI
â”œâ”€â”€ run_segmentation_pipeline.py # å®Œæ•´å·¥ä½œæµè„šæœ¬
â”œâ”€â”€ prepare_finetune_data.py   # æ–¹æ¡ˆ2: æ•°æ®å‡†å¤‡
â”œâ”€â”€ finetune_sam_med3d.py      # æ–¹æ¡ˆ2: æ¨¡å‹å¾®è°ƒ
â”œâ”€â”€ __init__.py
â””â”€â”€ README.md                   # æœ¬æ–‡æ¡£
```

### å„æ–‡ä»¶åŠŸèƒ½

| æ–‡ä»¶ | åŠŸèƒ½ | ä½¿ç”¨åœºæ™¯ |
|------|------|----------|
| `config.py` | é›†ä¸­ç®¡ç†æ‰€æœ‰è·¯å¾„å’Œå‚æ•°é…ç½® | ä¿®æ”¹æ•°æ®è·¯å¾„æ—¶ |
| `quick_start.py` | ç®€åŒ–å‘½ä»¤è¡Œç•Œé¢ | å¿«é€Ÿæ‰§è¡Œå¸¸ç”¨æ“ä½œ |
| `dicom_to_nifti.py` | DICOM åºåˆ—è½¬ NIfTI | æ•°æ®æ ¼å¼è½¬æ¢ |
| `interactive_segment.py` | 3D äº¤äº’å¼åˆ†å‰²ç•Œé¢ | æ–¹æ¡ˆ1 æ ¸å¿ƒå·¥å…· |
| `prepare_finetune_data.py` | å‡†å¤‡ SAM-Med3D è®­ç»ƒæ•°æ® | æ–¹æ¡ˆ2 æ•°æ®å‡†å¤‡ |
| `finetune_sam_med3d.py` | SAM-Med3D å¾®è°ƒè®­ç»ƒ | æ–¹æ¡ˆ2 æ¨¡å‹è®­ç»ƒ |

---

## ä¸ ivd_degeneration_analysis é›†æˆ

åˆ†å‰²å®Œæˆåï¼Œæ©ç æ–‡ä»¶å¯ç›´æ¥ç”¨äºç‰¹å¾æå–ï¼š

```bash
# 1. å®Œæˆåˆ†å‰²åï¼Œæ©ç åœ¨ ./output/masks/ ç›®å½•

# 2. å¯åŠ¨ç‰¹å¾æå– GUI
cd /home/nyuair/junyi/ivd_degeneration_analysis
python run_gui.py

# 3. åœ¨ GUI ä¸­:
#    - åŠ è½½å›¾åƒ: ./segmentation/output/nifti/liang.nii.gz
#    - åŠ è½½æ©ç : ./segmentation/output/masks/liang_mask.nii.gz
#    - é€‰æ‹©è¦æå–çš„ç‰¹å¾
#    - è¿è¡Œç‰¹å¾æå–
```

---

## å¸¸è§é—®é¢˜

### 1. æ¨¡å‹æƒé‡ä¸‹è½½å¤±è´¥

**æ–¹æ³•1**: ä½¿ç”¨æµè§ˆå™¨ç›´æ¥ä¸‹è½½
```
https://huggingface.co/blueyo0/SAM-Med3D/blob/main/sam_med3d_turbo.pth
```
ç„¶åå¤åˆ¶åˆ° `/home/nyuair/junyi/SAM-Med3D/ckpt/`

**æ–¹æ³•2**: ä½¿ç”¨ HuggingFace é•œåƒ
```bash
wget https://hf-mirror.com/blueyo0/SAM-Med3D/resolve/main/sam_med3d_turbo.pth \
    -O /home/nyuair/junyi/SAM-Med3D/ckpt/sam_med3d_turbo.pth
```

### 2. æ˜¾å­˜ä¸è¶³ (CUDA out of memory)

```bash
# æ–¹æ¡ˆ1: å‡å°æ‰¹æ¬¡å¤§å°
python finetune_sam_med3d.py --batch-size 1

# æ–¹æ¡ˆ2: å†»ç»“ç¼–ç å™¨
python finetune_sam_med3d.py --freeze-encoder

# æ–¹æ¡ˆ3: å‡å°å›¾åƒå°ºå¯¸
python finetune_sam_med3d.py --img-size 96
```

### 3. DICOM è½¬æ¢å¤±è´¥

æ£€æŸ¥ ZIP æ–‡ä»¶æ˜¯å¦å®Œæ•´ï¼š
```bash
unzip -t liang.zip
```

æ£€æŸ¥ DICOM æ–‡ä»¶æ ¼å¼ï¼š
```python
import pydicom
ds = pydicom.dcmread("MR.xxx.dcm")
print(ds)
```

### 4. äº¤äº’å¼ç•Œé¢æ— æ³•æ˜¾ç¤º

ç¡®ä¿ X11 è½¬å‘æ­£å¸¸ï¼ˆå¦‚æœé€šè¿‡ SSH è¿æ¥ï¼‰ï¼š
```bash
ssh -X nyuair@10.224.36.127
```

æˆ–ä½¿ç”¨ VNC è¿œç¨‹æ¡Œé¢è¿æ¥ã€‚

### 5. åˆ†å‰²ç»“æœä¸ç†æƒ³

- å¢åŠ æç¤ºç‚¹æ•°é‡ï¼ˆ5-10ä¸ªï¼‰
- åŒæ—¶ä½¿ç”¨å‰æ™¯ç‚¹å’ŒèƒŒæ™¯ç‚¹
- åœ¨å¤šä¸ªåˆ‡ç‰‡ä¸Šæ·»åŠ æç¤ºç‚¹
- è€ƒè™‘ä½¿ç”¨å¾®è°ƒåçš„æ¨¡å‹

---

## æŠ€æœ¯ç»†èŠ‚

### SAM-Med3D æ¨¡å‹

- **æ¶æ„**: åŸºäº Segment Anything Model (SAM) çš„ 3D æ‰©å±•
- **é¢„è®­ç»ƒ**: åœ¨ 143K 3D åŒ»å­¦å›¾åƒæ©ç ä¸Šè®­ç»ƒ
- **è¾“å…¥**: 128Ã—128Ã—128 ä½“ç´ 
- **æç¤ºç±»å‹**: ç‚¹å‡»ç‚¹ã€è¾¹ç•Œæ¡†

### æ•°æ®å¤„ç†æµç¨‹

1. **DICOM â†’ NIfTI**: ä½¿ç”¨ SimpleITK è¯»å– DICOM åºåˆ—ï¼Œä¿æŒç©ºé—´ä¿¡æ¯
2. **é¢„å¤„ç†**: Z-score å½’ä¸€åŒ–ï¼Œè£å‰ª/å¡«å……åˆ°ç›®æ ‡å°ºå¯¸
3. **åˆ†å‰²**: SAM-Med3D ç¼–ç å™¨æå–ç‰¹å¾ï¼Œè§£ç å™¨ç”Ÿæˆæ©ç 
4. **åå¤„ç†**: é˜ˆå€¼åŒ–ã€ä¿å­˜ä¸º NIfTI

---

## å‚è€ƒèµ„æ–™

- [SAM-Med3D è®ºæ–‡](https://arxiv.org/abs/2310.15161)
- [SAM-Med3D GitHub](https://github.com/uni-medical/SAM-Med3D)
- [ivd_degeneration_analysis GitHub](https://github.com/SgSc733/ivd_degeneration_analysis)
